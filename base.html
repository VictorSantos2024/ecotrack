<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EcoTrack - Flood Monitoring System{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 70px; /* keep content visible under fixed header */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
            transition: box-shadow 0.15s ease-in-out;
        }

        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .btn {
            border-radius: 0.375rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3, var(--primary-color));
        }

        .flood-level-low { 
            background: linear-gradient(135deg, #d1ecf1, #b8daff); 
            border-color: #bee5eb; 
            color: #0c5460; 
            border-radius: 0.5rem;
        }
        .flood-level-medium { 
            background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
            border-color: #ffeaa7; 
            color: #856404;
            border-radius: 0.5rem;
        }
        .flood-level-high { 
            background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
            border-color: #f5c6cb; 
            color: #721c24;
            border-radius: 0.5rem;
        }
        .flood-level-critical { 
            background: linear-gradient(135deg, #f8d7da, #dc3545); 
            border-color: #dc3545; 
            color: white;
            border-radius: 0.5rem;
            font-weight: bold;
        }

        .profile-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .profile-image-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #007bff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container-main {
            margin-top: 2rem;
            margin-bottom: 2rem;
            flex: 1 0 auto;
        }

        .alert {
            border: none;
            border-radius: 0.5rem;
        }

        .form-control, .form-select {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .table {
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            border-radius: 1rem;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
            border-radius: 0.5rem;
        }
        .image-preview-item {
            position: relative;
        }
        .alert-critical { background-color: #f8d7da; border-color: #dc3545; }
        .alert-high { background-color: #fff3cd; border-color: #ffc107; }
        .alert-medium { background-color: #cce7ff; border-color: #007bff; }
        .alert-low { background-color: #d1edff; border-color: #17a2b8; }
        .emergency-btn {
            transition: all 0.3s ease;
        }
        .emergency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .notification-item {
            transition: background-color 0.2s ease;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item:active {
            background-color: #e9ecef;
        }
        /* Full-width Emergency Contact bar */
        .emergency-contact-bar {
            background: linear-gradient(135deg, #dc3545, #b30024);
            color: #fff;
            padding: 18px 16px;
        }
        .emergency-contact-bar a { color: #fff; text-decoration: underline; }
        .emergency-contact-bar .contact-item { margin: 0 24px 8px; }
        .site-footer {
            background: #0d6efd;
            color: #fff;
            padding: 10px 16px;
            font-size: 0.95rem;
        }
       
    </style>
</head>
<body data-is-auth="{{ 'true' if current_user.is_authenticated else 'false' }}">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
            <div class="container">
                <a class="navbar-brand" href="{{ url_for('index') }}">
                    <i class="fas fa-water me-2"></i>EcoTrack
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        {% if current_user.is_authenticated %}
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('index') }}">
                                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                                </a>
                            </li>
                            {% if current_user.role in ['resident', 'brgy_official'] %}
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ url_for('report_flood') }}">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Report Flood
                                    </a>
                                </li>
                            {% endif %}
                            {% if current_user.role == 'admin' %}
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-cogs me-1"></i>Admin
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('admin_dashboard') }}">
                                            <i class="fas fa-chart-line me-2"></i>Dashboard
                                        </a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('analytics') }}">
                                            <i class="fas fa-analytics me-2"></i>Analytics
                                        </a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin_users') }}">
                                            <i class="fas fa-users me-2"></i>Users
                                        </a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin_reports') }}">
                                            <i class="fas fa-file-alt me-2"></i>Reports
                                        </a></li>
                                    </ul>
                                </li>
                            {% endif %}
                        {% endif %}
                    </ul>
                    <ul class="navbar-nav">
                        {% if current_user.is_authenticated %}
                            <li class="nav-item me-2" id="notificationsNav" style="display:none;">
                                <a class="nav-link position-relative" href="#" id="notificationsButton" onclick="toggleNotificationsDropdown(event)">
                                    <i class="fas fa-bell"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notifBadge" style="display:none;">0</span>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end p-0" id="notificationsDropdown" style="min-width: 320px; max-height: 360px; overflow-y: auto;">
                                    <div class="p-2 border-bottom d-flex justify-content-between align-items-center">
                                        <strong>Notifications</strong>
                                        <button class="btn btn-sm btn-link" onclick="markAllAlertsSeen()">Mark all as read</button>
                                    </div>
                                    <div id="notificationsList">
                                        <div class="p-3 text-muted">No notifications</div>
                                    </div>
                                </div>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                    {% if current_user.profile_image %}
                                        <img src="data:image/jpeg;base64,{{ current_user.profile_image }}" alt="Profile" class="profile-image me-2">
                                    {% else %}
                                        <i class="fas fa-user-circle me-2"></i>
                                    {% endif %}
                                    {{ current_user.first_name }}
                                </a>
                                <ul class="dropdown-menu">
                                    <li class="nav-item">
                                        <a style="color: #000000;" class="nav-link" href="{{ url_for('profile') }}">Profile</a>
                                    </li>
                                    <li class="nav-item">
                                        <a style="color: #000000;"class="nav-link" href="{{ url_for('flood_map') }}">Flood Map</a>
                                    </li>
                                    {% if current_user.barangay %}
                                    <li class="nav-item">
                                        <a style="color: #000000;" class="nav-link" href="{{ url_for('evacuation_routes', barangay=current_user.barangay) }}">Evacuation Routes</a>
                                    </li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="confirmLogout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a></li>
                                </ul>
                            </li>
                        {% else %}
                            
                            
                            
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>

    <main class="container container-main">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'exclamation-circle' if category == 'warning' else 'info-circle' }} me-2"></i>{{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <div class="emergency-contact-bar mt-auto">
        <div class="container d-flex flex-wrap align-items-center justify-content-center text-center">
            <div class="contact-item"><i class="fas fa-phone me-2"></i><strong>MDRRMO:</strong> <a href="tel:+639394008004">0939 400 8004</a></div>
            <div class="contact-item"><i class="fas fa-envelope me-2"></i><a href="mailto:tagudinmdrrmo@gmail.com">tagudinmdrrmo@gmail.com</a></div>
            <div class="contact-item"><i class="fab fa-facebook me-2"></i><a href="https://web.facebook.com/profile.php?id=100069411570562" target="_blank" rel="noopener">Facebook</a></div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-water me-2"></i>EcoTrack • Flood Monitoring System
            </div>
            <div class="text-end">
                &copy; {{ datetime.utcnow().year }} EcoTrack. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabel">
                        <i class="fas fa-sign-out-alt me-2"></i>Confirm Logout
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to logout from EcoTrack?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <a href="{{ url_for('logout') }}" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt me-1"></i>Yes, Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function confirmLogout() {
            const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));
            logoutModal.show();
        }
        // Notifications logic
        const NOTIF_KEY = 'ecotrack_seen_alerts_v1';
        let seenAlerts = new Set(JSON.parse(localStorage.getItem(NOTIF_KEY) || '[]'));
        let notifDropdownVisible = false;

        function toggleNotificationsDropdown(e) {
            e.preventDefault();
            const dropdown = document.getElementById('notificationsDropdown');
            notifDropdownVisible = !notifDropdownVisible;
            if (notifDropdownVisible) {
                dropdown.classList.add('show');
                const rect = document.getElementById('notificationsButton').getBoundingClientRect();
                dropdown.style.position = 'absolute';
                dropdown.style.inset = 'auto auto auto 0px';
            } else {
                dropdown.classList.remove('show');
            }
        }

        function markAllAlertsSeen() {
            const items = document.querySelectorAll('[data-alert-id]');
            items.forEach(el => seenAlerts.add(el.getAttribute('data-alert-id')));
            localStorage.setItem(NOTIF_KEY, JSON.stringify(Array.from(seenAlerts)));
            updateBadge(0);
        }

        function updateBadge(count) {
            const badge = document.getElementById('notifBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function notifyDesktop(alert) {
            try {
                if (Notification && Notification.permission === 'granted') {
                    const n = new Notification(alert.title || 'Emergency Alert', { body: alert.message });
                    setTimeout(() => n.close(), 8000);
                } else if (Notification && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            } catch (e) { /* ignore */ }
        }

        function severityBadgeClass(sev) {
            switch ((sev||'').toLowerCase()) {
                case 'critical': return 'bg-danger';
                case 'high': return 'bg-warning text-dark';
                case 'medium': return 'bg-primary';
                default: return 'bg-info text-dark';
            }
        }

        function renderAlerts(alerts) {
            const list = document.getElementById('notificationsList');
            list.innerHTML = '';
            if (!alerts.length) {
                list.innerHTML = '<div class="p-3 text-muted">No notifications</div>';
                updateBadge(0);
                return;
            }
            let unread = 0;
            alerts.forEach(a => {
                const seen = seenAlerts.has(String(a.id));
                if (!seen) unread++;
                const item = document.createElement('div');
                item.className = 'p-2 border-bottom';
                item.setAttribute('data-alert-id', a.id);
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge ${severityBadgeClass(a.severity)} me-2 text-uppercase">${a.severity}</span>
                            <strong>${a.title || ''}</strong>
                        </div>
                        ${seen ? '' : '<span class="mark-all-read">NEW</span>'}
                    </div>
                    <div class="small text-muted mt-1">${a.message || ''}</div>
                `;
                list.appendChild(item);
                if (!seen) {
                    notifyDesktop(a);
                    seenAlerts.add(String(a.id));
                }
            });
            localStorage.setItem(NOTIF_KEY, JSON.stringify(Array.from(seenAlerts)));
            updateBadge(unread);
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationsList');
            list.innerHTML = '';
            if (!notifications.length) {
                list.innerHTML = '<div class="p-3 text-muted">No notifications</div>';
                updateBadge(0);
                return;
            }
            let unread = 0;
            notifications.forEach(notification => {
                const seen = seenAlerts.has(String(notification.id));
                if (!seen) unread++;
                
                const item = document.createElement('div');
                item.className = 'p-2 border-bottom notification-item';
                item.setAttribute('data-alert-id', notification.id);
                
                // Add click handler for different notification types
                item.style.cursor = 'pointer';
                item.onclick = () => handleNotificationClick(notification);
                
                const severityClass = severityBadgeClass(notification.severity);
                const typeIcon = getNotificationTypeIcon(notification.type);
                
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge ${severityClass} me-2 text-uppercase">${notification.severity}</span>
                            <i class="${typeIcon} me-1"></i>
                            <strong>${notification.title || ''}</strong>
                        </div>
                        ${seen ? '' : '<span class="badge bg-success">NEW</span>'}
                    </div>
                    <div class="small text-muted mt-1">${notification.message || ''}</div>
                    <div class="small text-muted mt-1">
                        <i class="fas fa-clock me-1"></i>
                        ${formatRelativeTime(notification.created_at)}
                    </div>
                `;
                
                list.appendChild(item);
                if (!seen) {
                    notifyDesktop(notification);
                    seenAlerts.add(String(notification.id));
                }
            });
            localStorage.setItem(NOTIF_KEY, JSON.stringify(Array.from(seenAlerts)));
            updateBadge(unread);
        }

        function getNotificationTypeIcon(type) {
            switch (type) {
                case 'emergency_alert': return 'fas fa-exclamation-triangle text-danger';
                case 'flood_report': return 'fas fa-water text-info';
                case 'admin_notification': return 'fas fa-cog text-warning';
                default: return 'fas fa-bell text-primary';
            }
        }

        function formatRelativeTime(isoString) {
            const now = new Date();
            const time = new Date(isoString);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return time.toLocaleDateString();
        }

        function handleNotificationClick(notification) {
            // Mark as read
            seenAlerts.add(String(notification.id));
            localStorage.setItem(NOTIF_KEY, JSON.stringify(Array.from(seenAlerts)));
            
            // Handle different notification types
            switch (notification.type) {
                case 'emergency_alert':
                    // Could open emergency alert details
                    break;
                case 'flood_report':
                    // Redirect to flood reports page
                    window.location.href = "{{ url_for('admin_reports') }}";
                    break;
                case 'admin_notification':
                    if (notification.id === 'admin_pending_reports') {
                        window.location.href = "{{ url_for('admin_reports') }}";
                    } else if (notification.id === 'admin_new_users') {
                        window.location.href = "{{ url_for('admin_users') }}";
                    }
                    break;
            }
            
            // Update badge
            updateBadge(Math.max(0, parseInt(document.getElementById('notifBadge').textContent || '0') - 1));
        }

        async function fetchAlerts() {
            try {
                const res = await fetch("{{ url_for('api_alerts') }}", { credentials: 'same-origin' });
                if (!res.ok) return;
                const alerts = await res.json();
                document.getElementById('notificationsNav').style.display = 'block';
                renderAlerts(alerts);
            } catch (e) { /* ignore */ }
        }

        async function fetchNotifications() {
            try {
                const res = await fetch("{{ url_for('api_notifications') }}", { credentials: 'same-origin' });
                if (!res.ok) return;
                const notifications = await res.json();
                document.getElementById('notificationsNav').style.display = 'block';
                renderNotifications(notifications);
            } catch (e) { /* ignore */ }
        }

        // Initial and periodic fetch
        if ('Notification' in window) {
            try { Notification.requestPermission(); } catch (e) {}
        }
        const IS_AUTH = document.body.getAttribute('data-is-auth') === 'true';
        if (IS_AUTH) {
            // Fetch both alerts and notifications
            fetchAlerts();
            fetchNotifications();
            setInterval(fetchAlerts, 30000); // every 30s
            setInterval(fetchNotifications, 30000); // every 30s
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>