{% extends "base.html" %}

{% block title %}Profile - EcoTrack{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="mb-3">
                            {% if current_user.profile_image %}
                                <img src="data:image/jpeg;base64,{{ current_user.profile_image }}" alt="Profile Picture" class="profile-image-large">
                            {% else %}
                                <div class="profile-image-large d-flex align-items-center justify-content-center bg-light border">
                                    <i class="fas fa-user fa-4x text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        <h5 class="card-title">{{ current_user.first_name }} {{ current_user.last_name }}</h5>
                        <p class="text-muted">{{ current_user.role.replace('_', ' ').title() }}</p>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h6 class="text-primary">{{ current_user.reports|length }}</h6>
                                    <small class="text-muted">Reports</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6 class="text-success">{{ current_user.created_at|format_dt('%b %Y') }}</h6>
                                <small class="text-muted">Joined</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-user-edit me-2"></i>Edit Profile</h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data">
                            {{ form.hidden_tag() }}

                            <div class="mb-3">
                                {{ form.profile_image.label(class="form-label") }}
                                {{ form.profile_image(class="form-control", onchange="previewImage(this)") }}
                                <div class="form-text">Upload a profile picture (JPG, PNG only)</div>
                                <div id="imagePreview" class="mt-2"></div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.first_name.label(class="form-label") }}
                                        {{ form.first_name(class="form-control") }}
                                        {% if form.first_name.errors %}
                                            <div class="text-danger">
                                                {% for error in form.first_name.errors %}
                                                    <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.last_name.label(class="form-label") }}
                                        {{ form.last_name(class="form-control") }}
                                        {% if form.last_name.errors %}
                                            <div class="text-danger">
                                                {% for error in form.last_name.errors %}
                                                    <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form.email.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    {{ form.email(class="form-control") }}
                                </div>
                                {% if form.email.errors %}
                                    <div class="text-danger">
                                        {% for error in form.email.errors %}
                                            <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.barangay.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                            {{ form.barangay(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.phone.label(class="form-label") }}
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                            {{ form.phone(class="form-control") }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Removed address field as requested -->
                            <!-- Suggested Features: -->
                            <!-- 1. Two-Factor Authentication (2FA) for enhanced security. -->
                            <!-- 2. Integration with weather APIs to automatically fetch rainfall data. -->
                            <!-- 3. User activity log to track changes and actions. -->
                            <!-- 4. Advanced search and filtering for reports. -->
                            <!-- 5. Real-time notifications for new reports or important updates. -->
                            <!-- 6. A dashboard with key statistics and visualizations. -->
                            <!-- 7. Ability to export reports in different formats (CSV, PDF). -->
                            <!-- 8. User roles and permissions management for administrators. -->
                            <!-- 9. Geolocation services to automatically tag report locations. -->
                            <!-- 10. Community features like forums or discussion boards. -->

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Role</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                            <input type="text" class="form-control" value="{{ current_user.role.replace('_', ' ').title() }}" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Member Since</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                            <input type="text" class="form-control" value="{{ current_user.created_at|format_dt('%B %d, %Y') }}" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid">
                                {{ form.submit(class="btn btn-primary btn-lg") }}
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-key me-2"></i>Change Password</h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('change_password') }}">
                            {{ change_form.hidden_tag() }}
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ change_form.current_password.label(class="form-label") }}
                                        {{ change_form.current_password(class="form-control", autocomplete="current-password") }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ change_form.new_password.label(class="form-label") }}
                                        {{ change_form.new_password(class="form-control", autocomplete="new-password") }}
                                        <div class="form-text">At least 8 characters</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ change_form.confirm_new_password.label(class="form-label") }}
                                        {{ change_form.confirm_new_password(class="form-control", autocomplete="new-password") }}
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid">
                                {{ change_form.submit(class="btn btn-outline-primary") }}
                            </div>
                        </form>
                    </div>
                </div>
                {% if current_user.role != 'admin' %}
                <div class="card mt-3">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Feedback</h4>
                    </div>
                    <div class="card-body">
                        <form id="feedbackForm">
                            <div class="mb-3">
                                <label for="feedbackText" class="form-label">Your feedback</label>
                                <textarea id="feedbackText" class="form-control" rows="3" placeholder="Share your experience or suggestions..."></textarea>
                            </div>
                            <div id="feedbackStatus" class="mb-3" style="display:none;"></div>
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-primary" onclick="submitFeedback()">Submit Feedback</button>
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'image-preview';
            preview.appendChild(img);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

async function submitFeedback() {
    const textarea = document.getElementById('feedbackText');
    const statusBox = document.getElementById('feedbackStatus');
    const button = document.querySelector('#feedbackForm button[onclick="submitFeedback()"]');
    const text = (textarea.value || '').trim();
    if (!text) {
        statusBox.className = 'alert alert-warning';
        statusBox.textContent = 'Please enter your feedback before submitting.';
        statusBox.style.display = '';
        textarea.focus();
        return;
    }
    button.disabled = true;
    statusBox.style.display = 'none';
    try {
        const res = await fetch('{{ url_for('submit_feedback') if false else '/feedback' }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
            throw new Error((data && data.error) || 'Unable to submit feedback.');
        }
        statusBox.className = 'alert alert-success';
        statusBox.textContent = 'Thank you! Your feedback has been submitted.';
        statusBox.style.display = '';
        textarea.value = '';
    } catch (e) {
        statusBox.className = 'alert alert-danger';
        statusBox.textContent = e.message || 'Something went wrong submitting your feedback.';
        statusBox.style.display = '';
    } finally {
        button.disabled = false;
    }
}
</script>
{% endblock %}